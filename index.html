<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>QR Code Cœur Géométrique - Exportable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --qr-color: #e60000;
            --size: 200px; 
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #f4f4f4;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .controls { 
            margin-bottom: 80px; 
            display: flex;
            gap: 10px;
        }

        input { 
            padding: 12px; 
            width: 250px; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
            outline: none;
        }

        button { 
            padding: 12px 20px; 
            background: var(--qr-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            transition: opacity 0.2s;
        }

        button:hover { opacity: 0.9; }
        .btn-export { background: #333; }

        /* --- STRUCTURE DU COEUR --- */
        /* Conteneur de capture avec padding généreux */
        #capture-area {
            padding: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }

        .heart-wrapper {
            position: relative;
            width: var(--size);
            height: var(--size);
            transform: rotate(-45deg);
        }

        .qr-part {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: white;
        }

        #main-qr { z-index: 2; }

        #left-circle {
            top: calc(var(--size) / -2);
            left: 0;
            border-radius: 50% 50% 0 0;
            z-index: 1;
        }

        #right-circle {
            top: 0;
            left: calc(var(--size) / 2);
            border-radius: 0 50% 50% 0;
            z-index: 1;
        }

        .qr-part img {
            position: absolute;
            width: var(--size) !important;
            height: var(--size) !important;
            image-rendering: pixelated;
        }

        /* Alignement des motifs QR pour la continuité visuelle */
        #left-circle img { top: 0; }
        #right-circle img { left: 0; }

        #hidden-qr { display: none; }
    </style>
</head>
<body>

<div class="controls">
    <input id="text-input" value="https://google.com" placeholder="Entrez votre lien...">
    <button onclick="updateHeart()">GÉNÉRER</button>
    <button class="btn-export" onclick="exportHeart()">EXPORTER PNG</button>
</div>

<div id="capture-area">
    <div class="heart-wrapper">
        <div id="main-qr" class="qr-part"></div>
        <div id="left-circle" class="qr-part"></div>
        <div id="right-circle" class="qr-part"></div>
    </div>
</div>

<div id="hidden-qr"></div>

<script>
    // Fonction pour générer le QR Code
    function updateHeart() {
        const text = document.getElementById("text-input").value;
        const hiddenDiv = document.getElementById("hidden-qr");
        hiddenDiv.innerHTML = ""; 

        new QRCode(hiddenDiv, {
            text: text,
            width: 200,
            height: 200,
            colorDark: "#e60000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H // Niveau H requis car une partie du QR est masquée
        });

        setTimeout(() => {
            const qrImg = hiddenDiv.querySelector('img');
            if (qrImg) {
                const qrImageSrc = qrImg.src;
                const parts = ['main-qr', 'left-circle', 'right-circle'];
                parts.forEach(id => {
                    document.getElementById(id).innerHTML = `<img src="${qrImageSrc}">`;
                });
            }
        }, 100);
    }

    // Fonction pour exporter l'image avec des marges complètes
    function exportHeart() {
        const area = document.getElementById("capture-area");
        
        // Options optimisées pour capturer l'intégralité de l'image
        html2canvas(area, {
            backgroundColor: null,      // Fond transparent
            scale: 3,                   // Haute résolution
            logging: false,
            useCORS: true,              // Pour gérer les images externes
            allowTaint: true,
            width: area.scrollWidth,    // Largeur complète incluant le padding
            height: area.scrollHeight,  // Hauteur complète incluant le padding
            x: 0,                       // Capture depuis le début
            y: 0,
            windowWidth: area.scrollWidth,
            windowHeight: area.scrollHeight
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'qr-code-coeur.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    // Lancement initial
    updateHeart();
</script>

</body>
</html>
